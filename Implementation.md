This is the technical specification for the **Meta-Labeling "Sniper" Pipeline**.

This architecture decouples **Signal Generation** (finding opportunities) from **Signal Filtering** (risk management). The goal is to achieve >70% Precision by rejecting low-quality signals.

---

### **1. System Architecture Overview**



The system consists of two distinct sequential engines:
1.  **Engine A (The Spotter):** A deterministic, rule-based algorithm that runs on a continuous loop. It prioritizes **Recall** (finding every possible trend).
2.  **Engine B (The Sniper):** A probabilistic Machine Learning classifier (XGBoost/LightGBM). It prioritizes **Precision**. It only activates when Engine A emits a signal.

---

### **2. Data Layer Specifications**

* **Primary Timeframe:** 4-Hour (H4) Candles.
    * *Rationale:* Filters out H1 noise and HFT chop; patterns persist longer.
* **Secondary Timeframe:** 1-Hour (H1) Candles.
    * *Rationale:* Used solely for granular feature calculation (e.g., intra-candle volatility) and precise entry/exit simulation.
* **Asset Class:** EURUSD.
* **Data Horizon:** 2020–2025.
    * **Training Split:** 2020–2023.
    * **Validation Split:** 2024 (Hyperparameter tuning).
    * **Test Split:** Jan 2025 – Present (Strictly held out).

---

### **3. Engine A: Base Strategy ("The Spotter")**

This component must be **High Recall / Low Precision**. It should generate 500–1000 signals per year to provide sufficient training samples for the ML model.

**Logic: Volatility-Adjusted Trend Following**
* **Trend Filter:** 50-period EMA vs 200-period EMA.
    * *Long Context:* 50 > 200.
    * *Short Context:* 50 < 200.
* **Trigger Mechanism:** RSI (14) Pullback.
    * *Long Signal:* Trend is Long AND RSI dips below 40 (buying the dip).
    * *Short Signal:* Trend is Short AND RSI spikes above 60 (selling the rally).
* **Output:** A DataFrame of `Events` containing:
    * `signal_time`: Timestamp of the entry.
    * `signal_side`: 1 (Long) or -1 (Short).
    * `entry_price`: Close price of the signal candle.

---

### **4. The Meta-Labeling Logic (Triple Barrier Method)**

We do not use fixed Time Horizons (e.g., "Price in 4 hours"). We use **Path-Dependent Labels** to simulate realistic trading outcomes.

For every signal generated by Engine A, we observe the future price path until one of three barriers is touched:

1.  **Upper Barrier (Profit Take):** Entry Price + ($X \times$ ATR).
    * *Dynamic width based on market volatility.*
2.  **Lower Barrier (Stop Loss):** Entry Price - ($Y \times$ ATR).
    * *Dynamic width.*
3.  **Vertical Barrier (Time Expiration):** 24 Hours (6 bars of H4).

**The Target Variable ($Y$):**
* **1 (PASS/WIN):** Price hits Profit Take **before** hitting Stop Loss or Time Limit.
* **0 (FAIL/LOSS):** Price hits Stop Loss OR Time Limit **before** hitting Profit Take.

---

### **5. Engine B: The ML Filter ("The Sniper")**

The ML model learns the mapping: **Market Context ($X$) $\rightarrow$ Probability of Success ($Y$)**.

#### **Model Choice**
* **Algorithm:** XGBoost or LightGBM (Gradient Boosted Decision Trees).
* *Rationale:* Superior to Neural Networks (TCN/LSTM) for tabular data, handles discrete regimes better, and offers feature importance interpretability.

#### **Input Features ($X$)**
The model does *not* look at the signal logic. It looks at the **Context** at `signal_time`:

1.  **Volatility Regime Features:**
    * **ATR Ratio:** Current ATR / 30-day Moving Average ATR (Is volatility expanding or compressing?).
    * **Bollinger Band Width:** Normalized width.
2.  **Momentum Features:**
    * **ADX (Average Directional Index):** Is the trend strong or exhausted? (Key for avoiding "false breakouts").
    * **Distance from MA:** % distance from the 200 EMA (Is price overextended?).
3.  **Macro/External Features:**
    * **Calendar Proximity:** Minutes until next High Impact USD/EUR news.
    * **Macro Correlations:** 4H correlation with DXY (Dollar Index) and US10Y Yields.
    * **Sentiment:** LLM-derived sentiment score (from your existing pipeline).
4.  **Time Features:**
    * Hour of day (London Open, NY Open, Asian Lull).
    * Day of week.

---

### **6. Execution & Thresholding Logic**

This is where the >70% precision is manufactured.

1.  **Raw Prediction:** The model outputs a probability score $P \in [0, 1]$ for every signal.
2.  **Dynamic Thresholding:**
    * We do not use the standard 0.5 cutoff.
    * We optimize a threshold $\tau$ (e.g., 0.75) on the Validation set.
    * **Rule:** IF $P > \tau$ THEN Execute Trade. ELSE Ignore Signal.
3.  **Performance Metric:**
    * Optimize for **Precision** first, then **Profit Factor**.
    * Ignore Accuracy (Accuracy is irrelevant if we filter out 80% of trades).

---

### **7. Expected Workflow Transition**

1.  **Step 1 (Generate Events):** Run the "Spotter" script on 5 years of data. Save the list of ~4,000 trades.
2.  **Step 2 (Label Events):** Apply Triple Barrier logic to those 4,000 trades to create the "Truth" (Did they win or lose?).
3.  **Step 3 (Enrich):** Attach the features (Volatility, Macro, Sentiment) to those specific timestamps.
4.  **Step 4 (Train Filter):** Train XGBoost to differentiate the Winners from the Losers.
5.  **Step 5 (Backtest):** Run the simulation: Only take trades where XGBoost probability > 0.75.

### **Why this succeeds where TCN failed**
The TCN had to learn **"What is a trend?"** AND **"Is the volatility too high?"** AND **"Is news coming?"** all at once from raw prices.

This architecture hard-codes **"What is a trend?"** (using the Moving Averages) so the ML only has to learn **"When is it safe to enter?"** This reduces the problem dimensionality by 90%.
